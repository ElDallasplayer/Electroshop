<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi carrito</title>

    <!--CDNS-->
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://code.jquery.com/jquery-3.7.1.js"
      integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
      crossorigin="anonymous"
    ></script>

    <script type="text/javascript">
      var addthis_config = { data_track_addressbar: true };
    </script>
    <script
      type="text/javascript"
      src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4ff17589278d8b3a"
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/swiffy-slider@1.6.0/dist/js/swiffy-slider.min.js" crossorigin="anonymous" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/swiffy-slider@1.6.0/dist/css/swiffy-slider.min.css" rel="stylesheet" crossorigin="anonymous">

    <!--REFERENCIAS LOCALES-->
    <script src="../js/controllers/loadcomponents.js"></script>
    <link href="../css/site.css" rel="stylesheet" />
    
    <link href="./css/sales.css" rel="stylesheet" />
</head>
<body>
    <div id="vista-response" class="w-100"></div>
    <div id="chat-response" class="w-100" style="z-index: 95000;"></div>
    
    <div class="row p-0 m-0 d-none" id="contenedor_datos_precompra">
        <div class="row p-0 m-0 contenedor-blur-t" id=""></div>
        <div class="contenedor-opciones-precompra">
            <div class="row p-0 m-0" id="contenedor-form-envio">
                <h5 class="titulo-envio-tarjeta">Datos de contacto</h5>
                <p>
                    A continuacion le solitimacos que complete datos de contacto para coordinar el envio.
                </p>
                <div class="contenedor-opcion-envio">
                    <label class="form-label">Nombre completo:</label>
                    <input class="form-control m-0 mb-4"" type="text" id="nombre-completo-compra" placeholder="Nombre">
                    
                    <div class="m-0 mb-2">
                        <label class="form-label">Numero de contacto:</label>
                        <input class="form-control mb-2" type="text" id="numero-telefono-compra" placeholder="Numero">
                    </div>
                    
                    <div class="row w-100 p-0 m-0 mt-2">
                        <div class="btn btn-danger disabled" id="boton_continuarcompra">
                            <b>Continuar el pago</b>
                        </div>
                    </div>
                </div>
                <p>
                    Nos contactaremos con usted una vez este listo su pedido.
                    Muchas gracias!
                </p>
            </div>
        </div>
    </div>

    <div class="row p-0 m-0 d-none" id="contenedor_coordinar_envio">
        <div class="row p-0 m-0 contenedor-blur-t" id=""></div>
        <div class="contenedor-opciones-coordinar-envio">
            <div class="row p-0 m-0" id="contenedor-form-envio">
                <h5 class="titulo-envio-tarjeta">Seleccione una opcion</h5>
                <div class="contenedor-opcion-envio">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="flexSwitchCoordinarVendedor">
                        <label class="form-check-label" for="flexSwitchCoordinarVendedor">Coordinar el retiro con vendedor</label>
                      </div>
                      <div class="row w-100 p-0 m-0" id="contenedor_telefono">
                        <div>
                            <label>Telefono:</label>
                            <input type="number" id="numeroDetelefono" placeholder="Telefono">
                            <p>Terminos y condiciones aqui</p>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="flexSwitchRetirarRivadavia">
                        <label class="form-check-label" for="flexSwitchRetirarRivadavia">Retirar en Rivadavia al 1743, Polvorines</label>
                      </div>
                    <div class="row w-100 p-0 m-0" id="contenedor_mapa_rivadavia">
                        <div>
                            <iframe width="100%" class="map-container-rivadavia" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d4649.598058555849!2d-58.704617769957046!3d-34.50890951839645!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x95bca2d2a8900fa5%3A0x4800bdcb0b833a07!2sElectronorte%20Outlet!5e0!3m2!1ses!2sar!4v1726081706332!5m2!1ses!2sar" width="450" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                        </div>
                    </div>

                    <div class="row w-100 p-0 m-0 mt-2">
                        <div class="btn btn-danger" id="boton_confirma_cambios">
                            <b>Guardar cambios</b>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row p-0 m-0 d-none" id="contenedor_envio">
        <div class="row p-0 m-0 contenedor-blur-t" id=""></div>
        <div class="contenedor-opciones-envio">
            <div class="row p-0 m-0" id="contenedor-form-envio">
                <h5 class="titulo-envio-tarjeta">Seleccione destino</h5>
                <div class="contenedor-opcion-envio">
                    <label>Direccion:</label>
                    <input class="form-control" id="envio_direccion" type="text" placeholder="Direccion">
                </div>
                <div class="contenedor-opcion-envio">
                    <label>Codigo postal:</label>
                    <input class="form-control" id="envio_codigo_postal" type="text" placeholder="Codigo">
                </div>
                <div class="contenedor-opcion-envio">
                    <label>Localidad:</label>
                    <input class="form-control" id="envio_localidad" type="text" placeholder="Localidad">
                </div>
                <div class="contenedor-opcion-envio dual-option"></div>
                    <label>Entre calles:</label>
                    <input class="form-control" id="envio_calle1" type="text" placeholder="Calle 1">
                    <input class="form-control" id="envio_calle2" type="text" placeholder="Calle 2">
                </div>
                <div class="row w-100 p-0 m-0 mt-2">
                    <div class="btn btn-danger" id="boton_confirma_envio">
                        <b>CONFIRMAR Y CONTINUAR</b>
                    </div>
                </div>
                <div class="row w-100 p-0 m-0">

                </div>
            </div>
        </div>
    </div>
    <div class="row p-0 m-0 mt-4 w-100" id="principal-carrito-caontainer">
        <div class="col-12 w-100 p-0 m-0">
            <div class="row p-0 m-0 w-100 mb-5">
                 <div class="col-8" style="height: 400px;">
                    <div class="row m-3 shadow-interior justify-content-center" id="contenedor_tarjetas_reducidas">
                        
                    </div>
                 </div>
                 <div class="col-4" id="contenedor_opciones_compra">
                    <div class="row">
                        <div class="box-compra-container shadow-short">
                            <div class="titulo_contenedor_compra">
                                 <div class="contenedor_subtotales">
                                    <p class="valor_padre_subtotal">Productos: <b class="subtotal_compra_producto"></b></p>
                                    <p class="valor_padre_subtotal">Garantia extendia: <b class="subtotal_garantia_extendida">0</b></p>
                                    <p class="valor_padre_subtotal">Envio: <b class="subtotal_envio">0</b></p>
                                 </div>
                            </div>
                            <div class="titulo_contenedor_compra_total">
                                <div class="contenedor_totales_compra">
                                    <p class="contenedor-total-compra-realizar">Total: <b class="total_compra_a_realizar"></b> </p>
                                </div> 
                           </div>
                           <div class="boton_contenedor_agregar_garantia_extendida">
                                <div onclick="AgregarGarantiaExtendida()" class="boton_agregar_garantia_extendida shadow-short">
                                    <i class="mdi mdi-plus menos-boton-garantia"></i>
                                    <span id="text-mantenimiento-prepago">Mantenimiento prepago</span>
                                </div>
                                <div class="contenedor_input_garantia_extendia d-none">
                                    + <input type="number" value="1" class="input_garantia_extendida_meses"> a√±o/s
                                </div>
                            </div>
                            <div class="boton_contenedor_agregar_envio d-none">
                                <div onclick="HabilitarEnvio()" class="boton_agregar_garantia_envio shadow-short">
                                    <i class="mdi mdi-plus menos-boton-envio"></i>
                                    Envio
                                </div>
                                <div onclick="HabilitarCoordinarEnvio()" class="boton_agregar_convenir_envio shadow-short">
                                    Coordinar envio
                                </div>
                            </div>
                            <div class="boton_contenedor_compra">
                                 <div class="boton_acceder_a_compra shadow-short">
                                    Ir a pagar
                                 </div>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
    <script>
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        let guid = ObtenerGuidUser();
        const idProducto = params.get('articulo');
        let estaLogueado = false;
        $.get(DireccionPeticiones() +"/Product/GetCartProducts?userGuid=" + ObtenerGuidUser() + "&articleId=" + idProducto, (data) =>{
            $("#contenedor_tarjetas_reducidas").html(data)
            CalcularTotales()
            $(".input_cantidad_comprar_reducido").on("change", () =>{
                CalcularTotales()
            })
            $(".boton_eliminar_producto_carrito").on("click", () => {
                CalcularTotales()
            })
            AgregarFuncionesTarjetas()
            if(guid != null){
                estaLogueado = true;
            }
        })

        LoadComponent("../components/navbar.html","vista-response");
        LoadComponent("../components/chat.html","chat-response");

        $(window).on("scroll", () => {
            let altura = 60;
            if($(window).scrollTop() > altura){
                $("#contenedor_opciones_compra").addClass("contenedor_opciones_compra-fixed")
            }else{
                $("#contenedor_opciones_compra").removeClass("contenedor_opciones_compra-fixed")
            }
        })

        let valorMultiploGarantia = 0;
        let valorGarantia = 0;
        let aplicaGarantiaExtendida = false;
        
        let valorEnvio = 0;
        let aplicaEnvio = false;
        let coordinaEnvio = false;

        $.get(DireccionPeticiones() +"/Productos/ObtenerAtributos", (data) =>{
            data.map((x,y) => {
                console.log(x)
                if(x.nombre_Atributo == "PrecioEnvio"){
                    valorEnvio = Number(x.valor_Atributo)
                }else if(x.nombre_Atributo == "PrecioMantenimientoExtendido"){
                    valorMultiploGarantia = Number(x.valor_Atributo)
                }
            })
        })

        $(".input_garantia_extendida_meses").on("change", ()=>{
            let valoraAnios = Number($(".input_garantia_extendida_meses").val());
            if(valoraAnios < 1){
                $(".input_garantia_extendida_meses").val(1)
                valoraAnios = 1;
            }else if(valoraAnios > 2){
                $(".input_garantia_extendida_meses").val(2)
                valoraAnios = 2;
            }

            valorGarantia = valoraAnios * valorMultiploGarantia;
            CalcularTotales()
            $(".subtotal_garantia_extendida").html("$" + valorGarantia + ",00")
        })

        $(".boton_acceder_a_compra").on("click", (e) =>{
            e.stopImmediatePropagation();
            //if(estaLogueado){
            //    CompletarCompra()
            //}else{
                $("#contenedor_datos_precompra").removeClass("d-none")
            //}
        })

        $(".contenedor-blur-t").on("click", (e) =>{
            e.stopImmediatePropagation();
            console.log("entra a la fucion")
            if(!$("#contenedor_datos_precompra").hasClass("d-none")){$("#contenedor_datos_precompra").addClass("d-none")}
            if(!$("#contenedor_envio").hasClass("d-none")){$("#contenedor_envio").addClass("d-none")}
            if(!$("#contenedor_coordinar_envio").hasClass("d-none")){$("#contenedor_coordinar_envio").addClass("d-none")}
        })

        $("#boton_confirma_envio").on("click", (e) =>{
            e.stopImmediatePropagation();
                let polygon;
                
                var address = $("#envio_direccion").val();
                var apiKey = 'AIzaSyCfEAUKaGN9cM80MWAb2jOl_-cjDpplrvo'; // Reemplaza con tu clave de API

                $.ajax({
                    url: 'https://maps.googleapis.com/maps/api/geocode/json',
                    type: 'GET',
                    data: {
                        address: address,
                        key: apiKey
                    },
                    dataType: 'json',
                    success: function(data) {
                        if (data.status === 'OK') {
                            var location = data.results[0].geometry.location;

                            $.get( DireccionPeticiones() + "/Productos/ObtenerCoordenadasEnvios", (data) =>{
                                polygon = JSON.parse(data);
                                let res = isPointInPolygon(location.lat, location.lng, polygon.datas)
                                if(res){
                                    AgregarEnvioTotal();
                                }else{
                                    AgregarConvenirEnvioTotal();
                                }
                            })
                        } else {
                            console.log(data);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#result').html('Error: ' + error);
                    }
                });

            $("#contenedor_envio").addClass("d-none")
        })

        $("#contenedor_mapa_rivadavia").slideUp()
        $("#contenedor_telefono").slideUp()

        let checkpress1=false;
        $("#flexSwitchRetirarRivadavia").on("change", () =>{
            if(checkpress1 == false){
                checkpress1 = true;
                $("#contenedor_mapa_rivadavia").slideDown()
                checkpress2 = false;
                $("#contenedor_telefono").slideUp()
                $("#flexSwitchCoordinarVendedor").prop("checked",false)
            } 
            else{
                checkpress1 = false;
                $("#contenedor_mapa_rivadavia").slideUp()
            } 
        })    
        let checkpress2=false;
        $("#flexSwitchCoordinarVendedor").on("change", () =>{
            if(checkpress2 == false){
                checkpress2 = true;
                $("#contenedor_telefono").slideDown()
                checkpress1 = false;
                $("#contenedor_mapa_rivadavia").slideUp()
                $("#flexSwitchRetirarRivadavia").prop("checked",false)
            } 
            else{
                checkpress2 = false;
                $("#contenedor_telefono").slideUp()
            } 
        })    
        
        $("#boton_confirma_cambios").on("click", () =>{
            $("#contenedor_coordinar_envio").addClass("d-none")
        })

        $("#numero-telefono-compra").on("keyup", () =>{
            ValidarCamposCompra();
        })
        $("#nombre-completo-compra").on("keyup", () =>{
            ValidarCamposCompra();
        })

        function ValidarCamposCompra(){
            if($("#numero-telefono-compra").val() != ""){
                if($("#nombre-completo-compra").val() != ""){
                    if($("#numero-telefono-compra").val().length > 6){
                        $("#boton_continuarcompra").removeClass("disabled").off("click").on("click", () =>{
                            CompletarCompra();
                        })
                        return
                    }
                }
            }

            $("#boton_continuarcompra").addClass("disabled").off("click")
        }

        function AgregarGarantiaExtendida(){
            if(aplicaGarantiaExtendida){
                aplicaGarantiaExtendida = false;
                $("#text-mantenimiento-prepago").html("Mantenimiento prepago")
                $(".subtotal_garantia_extendida").html("0")
                $(".menos-boton-garantia").removeClass("mdi-minus").addClass("mdi-plus")
                $(".contenedor_input_garantia_extendia").addClass("d-none")
            }else{
                aplicaGarantiaExtendida = true;
                $("#text-mantenimiento-prepago").html("Quitar mantenimiento")
                $(".subtotal_garantia_extendida").html("$" + valorMultiploGarantia + ",00")
                $(".menos-boton-garantia").removeClass("mdi-plus").addClass("mdi-minus")
                $(".contenedor_input_garantia_extendia").removeClass("d-none")
            }
            CalcularTotales()
        }

        function HabilitarEnvio(){
            if(aplicaEnvio){
                aplicaEnvio = false;
                $(".subtotal_envio").html("0")
                $(".menos-boton-envio").removeClass("mdi-minus").addClass("mdi-plus")
                CalcularTotales();
            }else{
                $("#contenedor_envio").removeClass("d-none")
            }
        }

        function HabilitarCoordinarEnvio(){
            if(coordinaEnvio){
                coordinaEnvio = false;
                $(".subtotal_envio").html("0")
                $(".menos-boton-envio").removeClass("mdi-minus").addClass("mdi-plus")
                CalcularTotales();
            }else{
                $("#contenedor_coordinar_envio").removeClass("d-none")
            }
        }

        function AgregarEnvioTotal(){
                aplicaEnvio = true;
                $(".subtotal_envio").html("$" + valorEnvio + ",00")
                $(".menos-boton-envio").removeClass("mdi-plus").addClass("mdi-minus")
            CalcularTotales()
        }
        function AgregarConvenirEnvioTotal(){
                aplicaEnvio = true;
                $(".subtotal_envio").html("A convenir")
                $(".menos-boton-envio").removeClass("mdi-plus").addClass("mdi-minus")
        }

        let valorTotal = 0;
        function CalcularTotales() {
            valorTotal = 0;
            $(".total_articulo").map((a,e) => {
                valorTotal += Number($(e).val());
            })

            if(aplicaGarantiaExtendida){
                valorTotal += valorGarantia
            }

            if(aplicaEnvio){
                valorTotal += valorEnvio
            }

            $(".valor_total_productos").html("$" + valorTotal + ",00")
            $(".totales_ocultos_input").val(valorTotal)
            $(".subtotal_compra_producto").html("$" + valorTotal + ",00")
            $(".total_compra_a_realizar").html("$" + valorTotal + ",00")
        }

        function AgregarFuncionesTarjetas(){
            $(".boton_eliminar_producto_carrito").on("click", (e) =>{
                let elementId = e.target.getAttribute("id").replace("reducido_","")

                $("#contenedor_tarjeta_" + elementId).remove()

                $.get( DireccionPeticiones() +"/Product/DeleteProductInChart?articleId=" + elementId + "&userGuid=" + ObtenerGuidUser(), (data) =>{
                    ActualizarProductosCarrito(data.cantidad)
                })
            })
        }

        function isPointInPolygon(lat, lng, polygon) {
            let inside = false;
            const n = polygon.length;

            for (let i = 0, j = n - 1; i < n; j = i++) {
                const xi = polygon[i].lat, yi = polygon[i].lng;
                const xj = polygon[j].lat, yj = polygon[j].lng;

                const intersect = ((yi > lng) !== (yj > lng)) &&
                                (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }

            return inside;
        }

        function CompletarCompra(){
                const url = DireccionPeticiones() + "/Mercado/MakePayment";
                const data = {
                    id: 20,
                    products: [],
                    guidid: guid,
                    direction: {
                        direction: $("#envio_direccion").val(),
                        postalcode: $("#envio_codigo_postal").val(),
                        city: $("#envio_localidad").val(),
                        StreetBetweenLeft: $("#envio_calle1").val(),
                        StreetBetweenRigth: $("#envio_calle2").val()
                    },
                    clientpurchase: {
                        clientphone: ($("#numeroDetelefono").val() != ""?$("#numeroDetelefono").val() : $("#numero-telefono-compra").val()),
                        clientname: $("#nombre-completo-compra").val()
                    }
                };

                let productos = $(".boton_eliminar_producto_carrito")
                productos.map((x,y) => {
                    console.log(y)
                    let id = y.getAttribute("id").replace("reducido_","")
                    let quantity = $(".input_paraid_" + id).val();
                    let insertar = {id:id,quantity:quantity};
                    data.products.push(insertar);
                })
                console.log(data)
                fetch(url, {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data) 
                })
                .then(response => response.json()) 
                .then(data => {
                    window.open(data.url, '_blank');
                })
                .catch((error) => {
                    console.error('Error:', error); 
                });
        }

    </script>
</body>
</html>